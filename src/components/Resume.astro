---
// No props needed - component manages its own state
---

<div
    id="resume-container"
    class="bg-linear-to-br from-white via-gray-50 to-gray-100 rounded-2xl shadow-xl p-8 w-full border border-gray-200 overflow-hidden"
>
    <!-- Titre -->
    <div class="relative z-10">
        <h2
            class="text-3xl font-bold bg-linear-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent mb-2"
        >
            Votre configuration
        </h2>
        <p class="text-sm text-gray-500 mb-6">Résumé personnalisé</p>
    </div>

    <!-- Contenu du résumé -->
    <div id="resume-content" class="space-y-5 mb-8 relative z-10">
        <!-- Les données seront mises à jour par JavaScript -->
        <div class="text-center text-gray-400 py-8">
            <div class="inline-block animate-pulse">
                <div
                    class="w-8 h-8 border-3 border-primary/30 border-t-primary rounded-full"
                >
                </div>
            </div>
            <p class="mt-3">Chargement des informations...</p>
        </div>
    </div>

    <!-- Séparateur -->
    <div class="relative z-10 my-6">
        <div class="flex items-center gap-3">
            <div
                class="flex-1 h-px bg-linear-to-r from-gray-200 to-transparent"
            >
            </div>
        </div>
    </div>

    <!-- Section Prix et Actions -->
    <div class="relative z-10 space-y-4">
        <!-- Prix total -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-gray-500 text-sm mb-1">Montant total</p>
                    <p class="text-3xl font-bold text-gray-900">
                        <span id="prix-total">280€</span>
                    </p>
                </div>
                <div class="text-right text-xs text-gray-400">Prix estimé</div>
            </div>
        </div>

        <!-- Livraison offerte -->
        <div
            id="livraison-offerte"
            class="bg-linear-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl px-4 py-3 text-green-700 text-sm flex items-center gap-3 transition-all duration-300"
            style="display: none;"
        >
            <div class="shrink-0">
                <svg
                    class="w-5 h-5 text-green-600"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"
                    ></path>
                </svg>
            </div>
            <div>
                <p class="font-semibold text-green-900">Livraison offerte</p>
                <p class="text-xs text-green-700 opacity-80">
                    Pour les commandes supérieures à 200€
                </p>
            </div>
        </div>

        <!-- Boutons d'action -->
        <button
            class="btn btn-primary w-full h-12 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200 text-white"
        >
            <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
            </svg>
            Ajouter au panier
        </button>

        <!-- Boutons secondaires -->
        <div class="grid grid-cols-2 gap-3">
            <button
                id="save-btn"
                class="btn btn-outline btn-ghost rounded-xl h-10 text-sm font-medium border-gray-300"
            >
                Enregistrer
            </button>
            <button
                class="btn btn-outline btn-ghost rounded-xl h-10 text-sm font-medium border-gray-300"
            >
                Partager
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes pulse {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    :global(.animate-pulse) {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<script>
    import {
        getConfigurator,
        type ConfiguratorState,
        saveToPocketBase,
    } from "../lib/configuratorStore";

    function formatPrice(price: number): string {
        return new Intl.NumberFormat("fr-FR", {
            style: "currency",
            currency: "EUR",
        }).format(price);
    }

    function calculatePrice(state: ConfiguratorState): number {
        let price = 280; // Prix de base

        // Ajouter les prix des options
        if (state.options.emboutPersonnalises) price += 30;
        if (state.options.charnieresFlexibles) price += 40;
        if (state.options.gravurePersonnalisee) price += 25;

        return price;
    }

    function renderResume(state: ConfiguratorState): void {
        const container = document.getElementById("resume-content");
        if (!container) return;

        const sections = [
            {
                title: "Matériaux",
                items: [
                    {
                        label: "Monture",
                        value: state.materiaux.montureType || "Non sélectionné",
                    },
                    {
                        label: "Branches",
                        value:
                            state.materiaux.branchesType || "Non sélectionné",
                    },
                ],
            },
            {
                title: "Couleurs",
                items: [
                    {
                        label: "Couleur monture",
                        value: state.couleurs.monture || "Non sélectionné",
                    },
                    {
                        label: "Couleur branches",
                        value: state.couleurs.branches || "Non sélectionné",
                    },
                    {
                        label: "Couleur verres",
                        value: state.couleurs.verres || "Non sélectionné",
                    },
                ],
            },
            {
                title: "Dimensions",
                items: [
                    {
                        label: "Largeur verres",
                        value:
                            (state.tailles.largeurVerres || 48) + " mm" ||
                            "Non sélectionné",
                    },
                    {
                        label: "Hauteur verres",
                        value:
                            (state.tailles.hauteurVerres || 20) + " mm" ||
                            "Non sélectionné",
                    },
                    {
                        label: "Largeur pont",
                        value:
                            (state.tailles.largeurPont || 42) + " mm" ||
                            "Non sélectionné",
                    },
                ],
            },
            {
                title: "Finitions",
                items: [
                    {
                        label: "Type de finition",
                        value: state.finitions.type || "Non sélectionné",
                    },
                ],
            },
        ];

        let html = "";

        // Afficher les sections
        sections.forEach((section) => {
            html += `<div class="mt-6">
                <h3 class="text-sm font-bold text-gray-600 mb-3">${section.title}</h3>`;

            section.items.forEach((item) => {
                html += `
                    <div class="flex justify-between items-center pb-2 text-sm">
                        <span class="text-gray-700">${item.label}</span>
                        <span class="font-semibold text-gray-900">${item.value}</span>
                    </div>`;
            });

            html += `</div>`;
        });

        // Afficher les options sélectionnées
        const optionsActive = [
            state.options.emboutPersonnalises && "Embouts personnalisés",
            state.options.charnieresFlexibles && "Charnières flexibles",
            state.options.gravurePersonnalisee && "Gravure personnalisée",
        ].filter(Boolean);

        if (optionsActive.length > 0) {
            html += `<div class="mt-6">
                <h3 class="text-sm font-bold text-gray-600 mb-3">Options</h3>`;
            optionsActive.forEach((option) => {
                html += `<div class="flex items-center gap-2 pb-2 text-sm">
                    <span class="text-primary">✓</span>
                    <span class="text-gray-900">${option}</span>
                </div>`;
            });
            html += `</div>`;
        }

        container.innerHTML = html;
    }

    function updatePrice(state: ConfiguratorState): void {
        const prixTotal = document.getElementById("prix-total");
        const livraisonOfferte = document.getElementById("livraison-offerte");

        if (prixTotal) {
            const price = calculatePrice(state);
            prixTotal.textContent = formatPrice(price);
        }

        if (livraisonOfferte) {
            const price = calculatePrice(state);
            if (price > 200) {
                (livraisonOfferte as HTMLElement).style.display = "flex";
            } else {
                (livraisonOfferte as HTMLElement).style.display = "none";
            }
        }
    }

    function setupSaveButton(): void {
        const saveBtn = document.getElementById("save-btn");
        if (!saveBtn) return;

        saveBtn.addEventListener("click", async () => {
            // Afficher un état de chargement
            saveBtn.setAttribute("disabled", "true");
            const originalText = saveBtn.textContent;
            saveBtn.textContent = "Enregistrement...";

            try {
                // Appeler saveToPocketBase sans nom (il gérera l'affichage des modals)
                await saveToPocketBase("");
                saveBtn.textContent = "✓ Sauvegardé!";
                // Afficher un message de succès
                const msg = document.createElement("div");
                msg.className = "alert alert-success mt-4";
                msg.textContent = `Configuration sauvegardée avec succès!`;
                saveBtn.parentElement?.appendChild(msg);
                setTimeout(() => {
                    msg.remove();
                }, 3000);

                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.removeAttribute("disabled");
                }, 2000);
            } catch (error) {
                console.error("Erreur complète:", error);
                const errorMsg =
                    error instanceof Error ? error.message : String(error);

                // Afficher un message d'erreur structuré
                const msg = document.createElement("div");
                msg.className = "alert alert-error mt-4";
                msg.innerHTML = `<div class="flex flex-col gap-2">
                    <strong>Erreur lors de la sauvegarde:</strong>
                    <p>${errorMsg}</p>
                    ${error instanceof Error && error.cause ? `<p class="text-sm opacity-75">${error.cause}</p>` : ""}
                </div>`;
                saveBtn.parentElement?.appendChild(msg);
                setTimeout(() => {
                    msg.remove();
                }, 5000);

                saveBtn.textContent = originalText;
                saveBtn.removeAttribute("disabled");
            }
        });
    }

    function initResume(): void {
        const state = getConfigurator();
        renderResume(state);
        updatePrice(state);
        setupSaveButton();
    }

    // Initialiser au chargement
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initResume);
    } else {
        initResume();
    }

    // Écouter les changements du configurateur
    window.addEventListener("configurator-changed", (event: Event) => {
        const customEvent = event as CustomEvent;
        const state = customEvent.detail as ConfiguratorState;
        renderResume(state);
        updatePrice(state);
    });
</script>
