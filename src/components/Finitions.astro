---
interface Props {
    onFinitionChange?: (finition: { type: string }) => void;
}

const { onFinitionChange } = Astro.props;
---

<div class="w-full">
    <div class="join join-vertical w-full rounded-lg shadow-md">
        <div
            class="collapse collapse-arrow join-item border-2 border-base-300 bg-base-100 rounded-lg shadow-sm"
        >
            <input
                type="checkbox"
                id="finitions-accordion"
                class="peer"
                checked
            />
            <div class="collapse-title text-xl font-semibold cursor-pointer">
                <span>Finitions</span>
            </div>
            <div class="collapse-content bg-base-100">
                <div class="space-y-6 pt-4">
                    {/* Type de finition */}
                    <div class="space-y-4">
                        <h3 class="font-semibold text-black">
                            Type de finition
                        </h3>

                        {/* Mat */}
                        <div class="form-control">
                            <label
                                class="label cursor-pointer justify-start gap-3"
                            >
                                <input
                                    type="radio"
                                    id="finition-mat"
                                    name="finition"
                                    value="Mat"
                                    class="radio radio-primary"
                                    checked
                                />
                                <span class="label-text text-black"> Mat </span>
                            </label>
                        </div>

                        {/* Brillant */}
                        <div class="form-control">
                            <label
                                class="label cursor-pointer justify-start gap-3"
                            >
                                <input
                                    type="radio"
                                    id="finition-brillant"
                                    name="finition"
                                    value="Brillant"
                                    class="radio radio-primary"
                                />
                                <span class="label-text text-black">
                                    Brillant
                                </span>
                            </label>
                        </div>

                        {/* Brossé */}
                        <div class="form-control">
                            <label
                                class="label cursor-pointer justify-start gap-3"
                            >
                                <input
                                    type="radio"
                                    id="finition-brosse"
                                    name="finition"
                                    value="Brossé"
                                    class="radio radio-primary"
                                />
                                <span class="label-text text-black">
                                    Brossé
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            import { updateFinitions } from "../lib/configuratorStore";

            const finitionRadios = document.querySelectorAll(
                'input[name="finition"]',
            );

            // Initialiser depuis le localStorage
            function initializeFromStorage() {
                try {
                    const stored = localStorage.getItem("configurator_state");
                    if (stored) {
                        const state = JSON.parse(stored);
                        if (state.finitions && state.finitions.type) {
                            console.log(
                                "[Finitions] Initialisation depuis localStorage:",
                                state.finitions.type,
                            );

                            const selectedRadio = document.querySelector(
                                `input[name="finition"][value="${state.finitions.type}"]`,
                            ) as HTMLInputElement;

                            if (selectedRadio) {
                                selectedRadio.checked = true;
                                console.log(
                                    "[Finitions] Finition sélectionnée:",
                                    state.finitions.type,
                                );
                            }
                        }
                    }
                } catch (e) {
                    console.error(
                        "[Finitions] Erreur lors de la lecture du localStorage:",
                        e,
                    );
                }
            }

            function emitChanges() {
                const selectedRadio = document.querySelector(
                    'input[name="finition"]:checked',
                ) as HTMLInputElement;

                updateFinitions({
                    type: selectedRadio?.value || "Mat",
                });
            }

            finitionRadios.forEach((radio) => {
                radio.addEventListener("change", emitChanges);
            });

            // Initialiser avec un délai
            setTimeout(() => {
                initializeFromStorage();
            }, 50);
        </script>
    </div>
</div>
