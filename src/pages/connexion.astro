---
import Layout from "../layouts/Layout.astro";
import Google from "../assets/google.svg";
---

<Layout title="Connexion">
    <main
        class="min-h-[70vh] flex items-start md:items-center justify-center py-10 md:py-16 lg:py-20"
    >
        <div
            class="w-full max-w-sm md:max-w-md lg:max-w-lg px-4 mt-12 md:mt-16 lg:mt-20 mb-24 md:mb-32 lg:mb-40"
        >
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-normal text-base-content">
                    Connexion
                </h1>
                <p class="mt-2 text-sm md:text-base text-base-content">
                    Connectez-vous pour finaliser votre achat et accéder à votre
                    espace personnel
                </p>
            </div>

            <form id="loginForm" class="mt-8 space-y-4 md:space-y-5">
                <div class="form-control">
                    <label for="email" class="label">
                        <span class="label-text">Adresse email</span>
                    </label>
                    <input
                        id="email"
                        name="email"
                        type="email"
                        placeholder="votremail@exemple.com"
                        autocomplete="email"
                        required
                        class="input input-bordered w-full"
                    />
                </div>

                <div class="form-control">
                    <label for="password" class="label">
                        <span class="label-text">Mot de passe</span>
                    </label>
                    <input
                        id="password"
                        name="password"
                        type="password"
                        placeholder="Entrez votre mot de passe"
                        autocomplete="current-password"
                        required
                        class="input input-bordered w-full"
                    />
                </div>

                <div class="flex items-center justify-between">
                    <label
                        for="remember"
                        class="label cursor-pointer gap-3 p-0"
                    >
                        <input
                            id="remember"
                            name="remember"
                            type="checkbox"
                            class="checkbox checkbox-sm checkbox-primary"
                        />
                        <span class="label-text text-sm"
                            >Se souvenir de moi</span
                        >
                    </label>
                    <a
                        href="/mot-de-passe-oublie"
                        class="link link-primary text-sm"
                        >Mot de passe oublié ?</a
                    >
                </div>

                <button
                    type="submit"
                    class="btn btn-primary btn-block hover:bg-black! hover:text-white!"
                    >Se connecter</button
                >

                <div class="divider text-xs md:text-sm">Ou</div>

                <button
                    type="button"
                    id="googlelogin"
                    class="btn btn-outline btn-block gap-2"
                >
                    <img src={Google.src} alt="Google" class="h-5 w-5" />
                    Continuer avec Google
                </button>
            </form>

            <div id="msg" class="mt-4 text-center text-sm text-error"></div>

            <p class="mt-8 text-center text-sm text-base-content">
                Pas encore de compte ?
                <a class="link link-primary font-medium" href="/inscription"
                    >Inscrivez-vous</a
                >
            </p>

            <p class="mt-4 text-center text-xs text-base-content/60">
                En vous connectant, vous acceptez nos Conditions générales et
                notre Politique de confidentialité
            </p>
        </div>
    </main>
</Layout>

<script
    src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.4/dist/pocketbase.umd.js"
></script>
<script type="module">
    // URL de PocketBase
    const pbUrl =
        window.location.hostname === "localhost"
            ? "http://127.0.0.1:8090"
            : "https://sae-301.lorena-chevallot.fr:8084";

    const pb = new window.PocketBase(pbUrl);

    // Fonction pour enregistrer les cookies
    function setCookie(name, value, days = 7) {
        const date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        const expires = "expires=" + date.toUTCString();
        document.cookie =
            name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
    }

    // Fonction pour récupérer un cookie
    function getCookie(name) {
        const nameEQ = name + "=";
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.indexOf(nameEQ) === 0) {
                return decodeURIComponent(cookie.substring(nameEQ.length));
            }
        }
        return null;
    }

    // Fonction pour déterminer la URL de redirection
    function getRedirectUrl() {
        // Récupère l'URL du document référent
        const referrer = document.referrer;

        // Si le referrer existe et ne vient pas de connexion/inscription, retourner le chemin
        if (
            referrer &&
            !referrer.includes("/connexion") &&
            !referrer.includes("/inscription")
        ) {
            try {
                const referrerUrl = new URL(referrer);
                const path = referrerUrl.pathname;
                if (path !== "/" && path !== "") {
                    return path;
                }
            } catch (e) {
                console.error("Erreur lors du parsing du referrer:", e);
            }
        }

        // Par défaut, rediriger vers le configurateur
        return "/configurateur";
    }

    const form = document.getElementById("loginForm");
    form.onsubmit = async (e) => {
        e.preventDefault();
        try {
            const authData = await pb
                .collection("utilisateur")
                .authWithPassword(form.email.value, form.password.value);

            // Vérifiez si l'email est vérifié
            if (pb.authStore.isVerified === false) {
                document.getElementById("msg").textContent =
                    "Veuillez vérifier votre email avant de continuer.";
                return;
            }

            // Enregistrez les informations de connexion dans les cookies
            setCookie("pb_token", pb.authStore.token);
            setCookie("pb_user_id", pb.authStore.model.id);
            setCookie("pb_user_email", pb.authStore.model.email);
            setCookie(
                "pb_user_name",
                pb.authStore.model.username || pb.authStore.model.email,
            );

            // Optionnel : enregistrez si vous cochez "Se souvenir de moi"
            if (document.getElementById("remember").checked) {
                setCookie("pb_remember_me", "true", 30); // 30 jours
            }

            location.href = getRedirectUrl();
        } catch (err) {
            document.getElementById("msg").textContent = "Échec de connexion";
            console.error(err);
        }
    };

    const googlelogin = document.getElementById("googlelogin");
    googlelogin.onclick = async () => {
        try {
            await pb
                .collection("utilisateur")
                .authWithOAuth2({ provider: "google" });

            // Enregistrez les informations de connexion dans les cookies
            setCookie("pb_token", pb.authStore.token);
            setCookie("pb_user_id", pb.authStore.model.id);
            setCookie("pb_user_email", pb.authStore.model.email);
            setCookie(
                "pb_user_name",
                pb.authStore.model.username || pb.authStore.model.email,
            );

            location.href = getRedirectUrl();
        } catch (err) {
            document.getElementById("msg").textContent =
                "Échec de connexion Google";
            console.error(err);
        }
    };
</script>
